name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch: # Allows manual triggering

env:
  NODE_VERSION: '20.x'
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ubuntu
  EC2_KEY: ${{ secrets.EC2_SSH_KEY }}

jobs:
  deploy:
    name: Deploy to AWS EC2
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint
        continue-on-error: true

      - name: Build application
        run: npm run build

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ env.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            cd /opt/buytiktokcoins
            
            # Pull latest code
            git fetch origin
            git reset --hard origin/main || git reset --hard origin/master
            
            # Install dependencies
            npm ci --production
            
            # Build application
            npm run build
            
            # Run database migrations (if any)
            # Add your migration commands here if needed
            
            # Restart application with PM2
            pm2 restart buytiktokcoins-api || pm2 start dist/main.js --name buytiktokcoins-api
            
            # Save PM2 process list
            pm2 save
            
            # Show status
            pm2 status
            pm2 logs buytiktokcoins-api --lines 20
          ENDSSH

      - name: Health Check
        run: |
          sleep 5
          curl -f http://${{ secrets.EC2_HOST }}/api/health || echo "Health check endpoint not available"

      - name: Deployment Summary
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ðŸŒ API URL: http://${{ secrets.EC2_HOST }}/api"
          echo "ðŸ“Š Check logs: ssh -i ~/.ssh/deploy_key ${{ env.EC2_USER }}@${{ secrets.EC2_HOST }} 'pm2 logs buytiktokcoins-api'"

